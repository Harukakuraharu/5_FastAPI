# Микросервисное приложение для Spimex Trading Results

## Запуск проекта

Перед тем, как запустить приложение, необходимо склонировать репозиторий текущий репозиторий и репозиторий с [парсером](https://github.com/Harukakuraharu/4_Asyncio) к себе локально. 
Инициализируйте текущий репозиторий с помощью команды

```
git clone git@github.com:Harukakuraharu/5_FastAPI.git
```

Далее, необходимо открыть корневую директорию данного репозитрия локально в любой консоли и склонировать репозиторий с парсером:
```
cd 5_FastAPI - переход в корневую директорию приложения
git clone git@github.com:Harukakuraharu/4_Asyncio.git parser
```

Теперь внутри одного проекта будут два приложения - для отправки запросов и работы с базами данных. У обоих приложений свой репозиторий, можно проверить:

```
cd 5_FastAPI - переход в корневую директорию приложения
git remote -v

cd 5_FastAPI/parser - переход в директорию с парсером
git remote -v
```

### Приложение готово к запуску!

Для начала, в корневой директории необходимо создать файл **.env** в коревой директории, пример лежит в файле [env.example](https://github.com/Harukakuraharu/5_FastAPI/blob/main/env.example).
После этого, необхоимо выполнить команду сборки приложения, так же с корневой директории!

## Команда для сборки и запуска приложения

```
docker compose up --build -d
```

## Внимание. После сборки приложения и перед отправкой запросов, необходимо подождать минут 5, чтобы парсер отработал и заполнил базу данных.
Время парсера немного увеличено, т.к. сайт часто блокирует такое количество запросов, поэтому для крайней меры были добавлены функции *sleep()*.
Пока вы ждете загрузку данных, можно посмотреть видео со [смешными животными!](https://www.youtube.com/watch?v=f9VbU_pCh8w)
Посмотреть логи парсера можно по команде
```
docker compose logs parser
```
# Приложение для обработки запросов доступно по адресу **http://localhost/docs**. 

## Дополнительные команды
Если есть необходимость перезапустить определенные контейнеры:
```
docker compose up --build  --no-deps -d имя_контейнера
```
Eсли нужно остановить все контейнеры:
```
docker compose down -v
```
Eсли нужно открыть контейнер в консоли
```
docker compose exec имя_контейнера sh
```
Если нужно посмотртеть логи контейнера
```
docker compose logs имя_контейнера
```

## Запуск тестов
Для тестов инициализируется тестовая база данных Postgresql и Redis.
Если нужно запустить тесты, нужно сначала остановить все контейнеры и закоментировать некоторые параметры в **.env** файле:
```
REDIS_HOST
DB_HOST
```
После, если работаете с VSCode, перезапустите IDE, что бы **.env** подтянулись.
Теперь нужно собрать контейнер с тестовыми базами данных:

```
docker compose -f ./parser/docker-compose.yaml up --build -d
```
Запуск тестов:
```
pytest
```

После тестов, опустите контейнер с тестовой базой данных, если вновь хотите запустить приложение и раскомментируйте параметры в **.env**.
